<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Crawlspace Temp/Humidity Readings</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.1/plotly.min.js"
      integrity="sha512-GvBV4yZL+5zT68skQaXRW80H+S82WupIppDunAVt6pCLVdFmTv9tstetOqXv76L/z9WFl+0zY28QFKu0LAVFSg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <h1>Crawlspace Temperature & Humidity Readings</h1>

    <section>
      <h2>Latest Reading</h2>
      <p>Timestamp: <span>{{ latest.timestamp }}</span></p>
      <p>Temperature: <span>{{ latest.temperature }} F</span></p>
      <p>Humidity: <span>{{ latest.humidity }} %</span></p>
    </section>

    <section>
      <h2>Search History</h2>
      <form id="search-form" method="GET" action="/">
        <label for="date">Filter by Date</label>
        <input id="date" type="date" name="date" />
        <button id="clear-button">Clear Search</button>
      </form>
    </section>

    <section>
      <h2>Chart</h2>
      <div id="chart"></div>
    </section>

    <section>
      <button id="show-data-table">Show data table</button>
      <table id="data-table" class="hidden">
        <thead>
          <tr>
            <th>Date</th>
            <th>Temperature</th>
            <th>Humidity</th>
          </tr>
        </thead>
        <tbody>
          {% for date, temp, hum in history %}
          <tr>
            <th>{{ date }}</th>
            <td>{{ temp }} F</td>
            <td>{{ hum }} %</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <script>
      // Initialize form with date from URL
      const form = document.getElementById("search-form");
      const searchParams = new URLSearchParams(document.location.search);
      const searchDate = searchParams.get("date");
      form.date.value = searchDate;

      // Date input change handler
      const dateInput = document.getElementById("date");
      dateInput.addEventListener("change", submitDate);

      function submitDate() {
      	if (dateInput?.value) {
      		form.requestSubmit();
      	}
      }

      // Clear search button
      const clearButton = document.getElementById("clear-button");
      if (!searchDate) {
      	clearButton.style.display = "none";
      } else {
      	clearButton.addEventListener("click", clearSearch);
      }

      function clearSearch() {
      	form.date.value = "";
      	form.requestSubmit();
      }

      // Data table toggle
      const showDataTableButton = document.getElementById("show-data-table");
      const dataTable = document.getElementById("data-table");
      showDataTableButton.addEventListener("click", showDataTable);

      function showDataTable() {
      	if (dataTable.classList.contains("hidden")) {
      		dataTable.classList.remove("hidden");
      		showDataTableButton.innerText = "Hide data table";
      	} else {
      		dataTable.classList.add("hidden");
      		showDataTableButton.innerText = "Show data table";
      	}
      }

      // Plotly chart configuration
      const tempTrace = {
      	x: {{ chart_labels | tojson }},
      	y: {{ chart_temperature }},
      	type: 'scatter',
      	name: "Temperature",
      	line: { color: "red" }
      };

      const humTrace = {
      	x: {{ chart_labels | tojson }},
      	y: {{ chart_humidity }},
      	type: 'scatter',
      	name: "Humidity",
      	line: { color: "blue" }
      };

      Plotly.newPlot('chart', [tempTrace, humTrace]);
    </script>
  </body>
</html>
